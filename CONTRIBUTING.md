# CONTRIBUTING

感谢你愿意为炼丹蓝图前端贡献代码。

本仓库当前处于早期开发阶段，欢迎你通过 PR 一起完善节点编辑器、节点注册表联动、交互体验与文档体系。

## 1. 贡献前必读

- 许可证：本项目使用 AGPL-3.0，请确保你的贡献与许可证兼容。
- 目标定位：这是一个 AI 架构可视化编辑器，强调“像搭积木一样”构建与理解模型。
- 代码目标：可读、可维护、可扩展，优先面向理解而非炫技。

## 2. 本地开发环境

### 2.1 依赖与工具

- Node.js（建议使用 LTS 版本）
- Bun（推荐）或 npm
- 现代浏览器（Chrome / Edge）

### 2.2 安装与启动

```bash
# 安装依赖（任选其一）
bun install
# 或
npm install

# 启动开发服务器
bun dev
# 或
npm run dev
```

### 2.3 常用命令

```bash
# 代码检查
npm run lint

# 构建
npm run build

# 预览构建产物
npm run preview
```

> 说明：当前仓库未配置完整自动化测试流程。提交前至少保证 `npm run lint` 通过，并人工验证核心交互。

## 3. 项目架构速览

仓库是 Vite + React 的前端工程，核心是“命令层驱动 store，组件层做渲染和事件触发”。

### 3.1 目录职责

- `src/store.js`：全局状态中心（Zustand）
- `src/commands/`：业务命令层（蓝图、节点、连线、历史、剪贴板、自动记录）
- `src/components/`：UI 组件层（布局、画布、节点、面板、菜单、工具栏）
- `src/utils/`：纯计算工具（布局算法、坐标换算、ID 生成）
- `src/ws.js`：WebSocket 通信层（获取注册表、运行蓝图）
- `src/constants/config.js`：ReactFlow 行为配置

### 3.2 数据流约定

1. 用户在组件触发事件。
2. 组件调用 `window.cmd.*` 或命令函数。
3. 命令函数读写 `store`。
4. 组件通过 `useStore` 订阅状态并自动刷新。

### 3.3 核心设计原则

- 组件尽量“薄”：少放复杂业务逻辑。
- 逻辑尽量集中在 `commands` + `utils`。
- 修改状态优先走命令，保持行为可复用。
- 允许参数多形态输入（体现 Postel’s Law）。

## 4. 代码风格与实现要求

请遵循仓库既有风格（非常重要）：

1. **命令式写法优先**：代码分步写清楚，像积木拼接。
2. **函数输入灵活**：支持字符串/对象/数组等多种参数格式，并做防御式处理。
3. **命名清晰**：变量名、函数名使用驼峰命名，贴合业务语义。
4. **注释充分**：
   - 函数开头写用途与调用示例。
   - 关键逻辑写清楚“为什么”。
   - 尽可能多使用尾随注释解释代码。
5. **减少嵌套**：多用提前返回，避免深层 if。

## 5. 功能开发规范

### 5.1 新增命令（推荐流程）

1. 在 `src/commands/` 新增或扩展命令函数。
2. 保证函数参数支持合理的多调用形式。
3. 在 `src/commands/index.js` 暴露命令并挂载到 `window.cmd`。
4. 组件只调用命令，不直接散落业务逻辑。

### 5.2 状态字段变更

如果修改 `store` 字段结构，请同步更新：

- 使用该字段的组件
- 相关命令函数
- 导入导出逻辑（若受影响）
- 文档说明（README / CONTRIBUTING / 注释）

### 5.3 节点与注册表相关改动

涉及节点定义时，请同时考虑：

- 分类映射逻辑（侧边栏）
- 节点创建默认参数逻辑
- 参数面板渲染逻辑（`int/float/bool/list/enum/str`）
- 端口数据兼容性（对象结构与数组结构）

### 5.4 WebSocket 联动改动

涉及 `src/ws.js` 时，请注意：

- 请求/响应 `type` 命名一致
- `pending` 请求超时与清理逻辑完整
- 错误分支要有清晰日志
- 不破坏现有 `getRegistry` 与 `runBlueprint` 调用路径

## 6. 提交规范

### 6.1 分支建议

建议从 `main` 拉分支开发：

- `feat/xxx`：新功能
- `fix/xxx`：修复
- `refactor/xxx`：重构
- `docs/xxx`：文档

### 6.2 Commit 信息建议

建议使用简洁前缀：

- `feat:` 新增功能
- `fix:` 缺陷修复
- `refactor:` 重构
- `docs:` 文档更新
- `style:` 纯样式调整
- `chore:` 工具链/配置调整

示例：

```text
feat: 支持节点面板枚举参数下拉选择
fix: 修复输入端口拖拽断线重连失效
docs: 补充命令层开发约定
```

## 7. Pull Request 要求

请在 PR 描述中至少包含：

1. **变更目的**：解决什么问题。
2. **变更内容**：改了哪些模块。
3. **影响范围**：是否影响 store 字段、命令接口、注册表结构。
4. **验证方式**：如何手动验证（步骤尽量可复现）。
5. **截图/录屏**：涉及 UI 或交互变更时必须提供。

## 8. 提交前自检清单

提交 PR 前请确认：

- [ ] 本地可启动并正常交互
- [ ] `npm run lint` 通过
- [ ] 关键路径已手动验证（创建节点、连线、重命名、删除、撤销重做）
- [ ] 变更未引入明显控制台报错
- [ ] 新增逻辑已补充注释与用法示例
- [ ] 文档与注释已同步更新

## 9. 适合优先贡献的方向

- 新节点类型与注册表适配
- NodePanel 参数编辑体验优化
- 自动布局算法可读性与稳定性优化
- 键盘快捷键与交互细节补强
- 文档体系完善（架构、命令说明）

---

感谢你的贡献。保持“小步提交、清晰注释、命令驱动”的风格，可以让协作效率显著提升。