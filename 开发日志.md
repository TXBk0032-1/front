# 炼丹蓝图 开发日志

> 这份文档记录了整个项目从零开始的开发过程，包括每一步的想法、决策和具体操作。
>
> **文档用途：**
> - 梳理开发思路，让自己想清楚再动手
> - 方便团队成员了解项目进度和变更原因
> - 作为个人学习和成长的记录

---

## 一、开发原则

开发过程中遵循的核心原则：

| 原则 | 说明 |
|------|------|
| **KISS** | 保持简单，别搞复杂 |
| **MVP** | 先做核心功能，别一开始就想做大而全 |
| **DRY** | 不要重复自己，能复用就复用 |
| **YAGNI** | 用不到的功能别提前做 |

**个人补充：**
- 代码要让人看得懂，别为了炫技写得很绕
- AI可以帮忙补全代码，但别让AI一次性生成大段代码
- 注释要写大白话，别写得跟论文一样

## 二、项目目标

做一个 **AI模型架构可视化设计工具**，就像 Scratch 那样拖拖拽拽就能搭建模型。

**想解决的问题：**
- 不会写代码的人也能搭建AI模型
- 研发人员可以快速验证架构想法
- 降低AI架构设计的门槛

## 三、技术栈

| 类型 | 技术 |
|------|------|
| 前端框架 | React |
| 可视化库 | React Flow |
| UI组件库 | heroUI |
| 构建工具 | Vite |
| 前端语言 | JavaScript |
| 后端语言 | Python |
| ML框架 | PyTorch |

## 四、开发计划

### 前端（本阶段重点）

| 阶段 | 任务 | 状态 |
|------|------|------|
| 1 | 搭建基础环境，接入 React Flow | ✅ 完成 |
| 2 | 封装通用节点组件 | ✅ 完成 |
| 3 | 实现类似 Scratch 的交互操作 | ✅ 完成 |

### 后端（待开发）

| 阶段 | 任务 |
|------|------|
| 1 | 节点定义系统：用修饰器定义节点，导出配置给前端 |
| 2 | 执行引擎：解析蓝图结构，自动构建计算图 |
| 3 | 验证评估：测试数据流通性，跑分 |

### 前后端通信（待开发）

| 阶段 | 任务 |
|------|------|
| 1 | 架构下发：前端把模型架构发给后端执行 |
| 2 | 结果反馈：后端执行结果实时同步到前端 |

---

## 五、开发日志

> 下面是实际开发过程的流水账记录，按时间顺序写的。

---

### Step 1：创建项目

用 `yarn create vite` 创建项目：
- 项目名：`ai-blueprint`
- 框架：React
- 语言：JavaScript

---

### Step 2：安装 React Flow

```bash
yarn add @xyflow/react
```

---

### Step 3：接入 React Flow

读了下文档，发现挺简单的：
1. 导入 React Flow 组件
2. 用 hook 管理节点和连线状态
3. 把状态传给 ReactFlow 组件

改了 `App.jsx`，跑起来能用了。

---

### Step 4：封装通用节点组件

创建了 `BaseNode` 组件：
- 导入 React Flow 的 Handle 和 Position
- 写了节点的基础布局和外观
- 在 `App.jsx` 里注册这个组件

**样式写法的纠结：**
一开始想用对象式写法（类似 Vue），后来发现伪类不好处理，改成了独立的 CSS 文件。

---

### Step 5：编写节点注册表

因为还没后端，先写个假数据模拟节点列表。

**设计的数据结构：**
```js
{
  // 分类信息
  categories: {
    "分类ID": { label: "显示名", color: "主题色", nodes: ["节点ID列表"] }
  },
  // 节点配置
  nodes: {
    "节点ID": {
      label: "显示名",
      inputs: [{ id: "in", label: "输入" }],
      outputs: [{ id: "out", label: "输出" }],
      params: {
        "参数名": { label: "显示名", type: "类型", default: "默认值" }
      }
    }
  }
}
```

---

### Step 6：实现节点面板（NodeBox）

想做一个类似 Scratch 左边的积木栏，可以从里面拖节点出来。

**遇到的问题：**
想实现"把节点拖回去删除"的功能，但 React Flow 的 Panel 组件层级太高，节点显示不到它上面。

**最终决定：**
遵循 MVP 原则，先用 Panel 组件，"拖回删除"功能以后再说。

完成了节点盒的显示，下一步是实现拖拽生成。

---

### Step 7：实现节点拖拽生成

从节点盒拖节点到画布，松手就生成。

**实现思路：**
1. `NodeBox.jsx`：给节点加 `draggable`，拖拽时把节点ID存到 `dataTransfer`
2. `App.jsx`：监听 `onDrop`，获取节点ID，把屏幕坐标转成画布坐标，创建节点

**小优化：**
设置 `nodeOrigin={[0.5, 0.5]}`，让节点以鼠标位置为中心生成，而不是左上角对齐。

---

### Step 8：第一次代码重构

代码写到一半发现有点乱了，按照 KISS、DRY 原则做了一次整理。

**主要改动：**
- `nodeRegistry.js`：加了4个辅助函数（`getNodeConfig`、`getNodeColor` 等），其他文件不用再写一堆查找逻辑
- `BaseNode.jsx`：把 `PortHandle` 拆成 `InputPort` 和 `OutputPort`，各管各的
- `App.jsx`：把重复逻辑抽成函数，加了大白话注释

---

### Step 9：规划交互功能

列了一下需要实现的交互功能：

**必要功能：**
- 删除：按 Del 键删除选中节点
- 拔线：拖拽输入端口时，如果已有连线就断开，像拔插头一样
- 限制连接：输入端口只能接一根线，输出端口不限

**重要功能：**
- 框选：右键拖拽框选多个节点
- 撤销/重做：Ctrl+Z / Ctrl+Y
- 复制/粘贴：Ctrl+C / Ctrl+V

---

### Step 10：第二次代码重构（模块化）

App.jsx 太长了，做了一次大规模拆分：

| 新文件 | 功能 |
|--------|------|
| `useHistory.js` | 撤销/重做 |
| `useClipboard.js` | 复制/粘贴 |
| `useKeyboardShortcuts.js` | 键盘快捷键监听 |
| `createNode.js` | 创建节点对象 |
| `initialData.js` | 初始节点和连线 |
| `flowConfig.js` | React Flow 配置 |


---

### Step 11：零碎优化

这段时间做了一些零碎的优化，没有大的功能点：

- 给拖拽时的连接线加了样式，和创建后的样式保持一致
- 修复了节点盒拖拽的 bug（在节点盒区域松手也会创建节点）
- 写了分类栏，可以筛选节点盒中的节点
- 加了一些图标素材

---

### Step 12：实现右键菜单

右键点击节点弹出菜单，三个选项：
- 复制粘贴（在原位置偏移一点创建副本）
- 删除节点
- 重命名（双击节点也能触发）

**重命名功能：**
弹出 heroUI 的弹窗，输入框里显示当前名称，确认后更新。

---

### Step 13：第三次代码重构

App.jsx 还是太长了，又拆了一波：

| 新 Hook | 功能 |
|---------|------|
| `useContextMenu.js` | 右键菜单显示/隐藏 |
| `useRename.js` | 重命名弹窗 |
| `useNodeActions.js` | 节点操作（复制、删除） |
| `useFlowEvents.js` | 画布事件处理 |

重构后的 App.jsx 只负责"接线"，具体逻辑都在 hooks 里。

**顺便修了个 bug：**
框选节点后右键没法弹菜单，现在修好了，还支持批量操作。

---

### Step 14：实现属性面板

右键节点时在节点下方弹出属性面板，可以编辑节点参数。

**功能：**
- 根据参数类型自动生成编辑控件（数字、文本、开关）
- 动态跟随节点移动
- 随画布缩放

**位置布局：**
- 右键菜单：固定在节点上方
- 属性面板：固定在节点下方

这样两个面板不会重叠。

---

### 🎉 前端核心功能完成！

## 六、架构总结

### 目录结构

```
src/
├── App.jsx           # 主入口，组装所有模块
├── main.jsx          # React 启动点
├── components/       # UI 组件
├── hooks/            # 功能逻辑（Hooks）
├── config/           # 配置文件
├── constants/        # 常量数据（节点注册表）
└── utils/            # 工具函数
```

### 核心组件

| 组件 | 作用 |
|------|------|
| `BaseNode.jsx` | 节点模板，支持"拔线"功能 |
| `NodeBox.jsx` | 左侧积木盒，拖拽生成节点 |
| `NodeContextMenu.jsx` | 右键菜单（复制、删除、重命名） |
| `PropertyPanel.jsx` | 属性面板，编辑节点参数 |
| `RenameModal.jsx` | 重命名弹窗 |

### Hooks 模块

| Hook | 作用 |
|------|------|
| `useHistory` | 撤销/重做 |
| `useClipboard` | 复制/粘贴 |
| `useKeyboardShortcuts` | 键盘快捷键 |
| `useContextMenu` | 右键菜单控制 |
| `usePropertyPanel` | 属性面板控制 |
| `useRename` | 重命名弹窗控制 |
| `useNodeActions` | 节点操作（复制、删除） |
| `useFlowEvents` | 画布事件处理 |

### 设计思想

1. **模块化**：每个功能独立成文件，改一个不影响其他
2. **单向数据流**：状态 → 组件 → 用户看到
3. **关注点分离**：组件管 UI，Hooks 管逻辑，Config 管配置
4. **大白话注释**：代码里到处都是注释，一看就懂

### 常见修改场景

| 想做什么 | 改哪个文件 |
|----------|-----------|
| 加新节点类型 | `nodeRegistry.js` |
| 加新快捷键 | `useKeyboardShortcuts.js` |
| 加新参数类型 | `PropertyPanel.jsx` |
| 改节点外观 | `BaseNode.jsx` + `BaseNode.css` |
| 改右键菜单 | `NodeContextMenu.jsx` |
| 改画布配置 | `flowConfig.js` |

---

**总结**：代码结构清晰，每个文件职责明确。想改什么功能，找到对应文件就行。