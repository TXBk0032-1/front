# 项目解读（大白话版）

> 适用对象：第一次接触本仓库的开发者、准备提 PR 的贡献者。
>
> 参考依据：[`项目架构.txt`](项目架构.txt) + 现有源码实现。

---

## 0. 先用三句话把项目说透

1. 这是一个“AI 蓝图编辑器”前端，你可以在画布里拖节点、连线、改参数、运行蓝图。  
2. 架构核心是：**组件负责界面和事件，命令负责改状态，store 负责全局数据，utils 负责计算**。  
3. 写代码风格偏“积木式命令流”：一步一步写清楚，参数尽量兼容，注释尽量用大白话。

---

## 1. 项目开发思想与哲学（最重要）

这个项目不是追求“最少代码行数”，而是追求“下一个人一看就懂”。

### 1.1 命令式优先，不玩花活

项目大量逻辑放在 `commands` 里，用函数一步步做事情，比如：

- 选中节点：先拿状态 -> 处理传参 -> 更新 `selectedIds`
- 创建节点：先解析参数 -> 从注册表取定义 -> 生成 id -> 合并默认参数 -> 入库

这样写的好处是：

- 调试容易
- 改需求时不容易误伤
- 组件层会很干净

### 1.2 Postel’s Law（接受多变，输出保守）

很多命令都支持多种调用方式，比如：

- 可以传字符串，也可以传对象
- 可以传单个 id，也可以传数组
- 能兜底默认值就兜底，不直接炸

这让上层调用很灵活，但命令层要自己把复杂度吃掉。

### 1.3 面向理解编程

你会看到大量注释，尤其函数头有“用法示例”。这不是啰嗦，是为了让贡献者能快速理解并安全改动。

---

## 2. 从启动到界面出现，程序到底做了什么

按真实执行顺序看：

1. 浏览器加载 [`index.html`](index.html)  
2. 入口脚本跑 [`src/main.jsx`](src/main.jsx)  
3. 先导入 [`src/commands/index.js`](src/commands/index.js)，把命令挂到 `window.cmd`，并初始化历史记录与自动记录  
4. React 渲染 [`src/App.jsx`](src/App.jsx)  
5. `App` 组装页面：`Header + Sidebar + Blueprint + RenameModal`  
6. `Sidebar` 初次加载会请求后端注册表（节点定义）  
7. 用户开始拖节点、连线、改参数，所有状态更新都回到 [`src/store.js`](src/store.js)

---

## 3. 架构总览（按职责分层）

- **UI 层（components）**：负责“看得见”的东西和事件绑定  
- **命令层（commands）**：负责“怎么改数据”  
- **状态层（store）**：负责“数据放哪、谁来订阅”  
- **计算层（utils）**：负责“纯算法/纯转换”  
- **通信层（ws）**：负责“和后端说话”

一句话：**组件不硬改状态，组件发命令，命令改 store，store 通知组件更新。**

---

## 4. 全仓库逐文件解读（全面版）

## 4.1 根目录文件

### [`package.json`](package.json)

项目依赖和脚本中心：

- 技术栈：React 19 + Vite + ReactFlow + Zustand + HeroUI
- 脚本：`dev / build / lint / preview`

你加新库、改脚本都在这里。

### [`bun.lock`](bun.lock)

Bun 的锁定文件，保证依赖版本可复现。一般不手改。

### [`vite.config.js`](vite.config.js)

Vite 配置：

- React 插件
- Tailwind 插件
- `@` 指向 `src`

### [`eslint.config.js`](eslint.config.js)

ESLint 规则，当前偏宽松（例如关闭了未使用变量报错）。

### [`index.html`](index.html)

宿主页面。重点：

- `#root` 是 React 挂载点
- 引入 `src/main.jsx`
- 有很完整的 `noscript` 提示

### [`README.md`](README.md)

项目门面文档：介绍、截图、快速开始、许可证、社区信息。

### [`CONTRIBUTING.md`](CONTRIBUTING.md)

贡献规范文档：怎么提 PR、怎么写提交、开发规范。

### [`LICENSE`](LICENSE)

AGPL-3.0 许可证全文。涉及二次分发、商用方案时必须看。

### [`.gitignore`](.gitignore)

忽略规则：依赖目录、构建产物、日志、IDE 文件等。

### [`项目架构.txt`](项目架构.txt)

这个是“产品逻辑 + 开发思想”的原始蓝图文档。

---

## 4.2 展示与静态资源目录

### [`display/节点右键功能展示图.png`](display/节点右键功能展示图.png)
### [`display/全功能节点连线架构演示.png`](display/全功能节点连线架构演示.png)

这两个是 README 展示图，用来说明交互效果。

### [`public/logo.svg`](public/logo.svg)

网页 favicon / 项目标识图。

---

## 4.3 src 目录总览

`src` 是核心代码区。

### [`src/main.jsx`](src/main.jsx)

应用真正入口：

- 启动 React
- 提供 `ReactFlowProvider`
- 初始化全局命令（通过导入 `commands/index`）

### [`src/App.jsx`](src/App.jsx)

页面骨架组件：

- 顶部：`Header`
- 左侧：`Sidebar`
- 主画布：`Blueprint`
- 全局弹窗：`RenameModal`

### [`src/store.js`](src/store.js)

全局状态中枢（Zustand）。

主要状态块：

- 蓝图数据：`blueprintName / nodes / edges`
- 选择状态：`selectedIds / selectedCategory`
- 视口：`viewport`
- UI 浮层：`nodeMenu / nodePanel / renameModal`
- 历史：`history / historyIndex`
- 剪贴板：`clipboard`
- 注册表：`registry`

这里是“单一事实来源”，大多数逻辑都围着它转。

### [`src/ws.js`](src/ws.js)

WebSocket 管理器（类封装）：

- `connect()`：连接后端
- `send()`：带超时和 pending 管理的请求发送
- `getRegistry()`：取节点定义并写入 store
- `runBlueprint()`：发送当前蓝图给后端执行

如果你要对接后端协议，这里是第一入口。

---

## 4.4 constants（配置与示例结构）

### [`src/constants/config.js`](src/constants/config.js)

ReactFlow 交互配置：

- 拖拽画布按键
- 框选行为
- 删除键
- 默认连线样式
- fitView 等

### [`src/constants/registry_example.json`](src/constants/registry_example.json)

节点注册表示例，非常关键。定义了：

- 分类 `categories`
- 节点 `nodes`
- 端口结构 `ports.input / ports.output`
- 参数结构（支持 int/float/bool/str/list/enum）

仅供参考，节点定义由后端提供。

---

## 4.5 commands（命令层，项目灵魂）

> 这里是“行为中心”。建议先看这个目录，再看组件。

### [`src/commands/index.js`](src/commands/index.js)

命令总入口：

- 汇总所有命令
- 挂载到 `window.cmd`
- 初始化历史首条记录
- 启动自动记录

### [`src/commands/Blueprint.js`](src/commands/Blueprint.js)

蓝图级命令：

- `arrange`：自动布局
- `zoomIn / zoomOut / resetZoom / setViewport`
- `importBlueprint / exportBlueprint`
- `setBlueprintName`

### [`src/commands/Node.js`](src/commands/Node.js)

节点命令：

- 选择：`selectNode / toggleSelectNode / clearSelect`
- 生命周期：`createNode / deleteNode / deleteSelectedNodes / renameNode`
- 属性：`updateNodeParam / moveNode`
- 查询：`getNodeById / getSelectedNodes`

特点：参数适配很灵活，做了大量兜底。

### [`src/commands/Edge.js`](src/commands/Edge.js)

连线命令：

- `createEdge`：支持对象和简写参数
- `deleteEdge`：支持按 id、按端口、按数组删除
- `getEdgesByNode / getEdgeByPort / getConnectedEdgeFromInputPort`

还处理了“输入端口只保留一条连接”的替换逻辑。

### [`src/commands/History.js`](src/commands/History.js)

撤销重做系统：

- `record`
- `undo`
- `redo`
- `canUndo / canRedo`
- `clearHistory / getHistoryInfo`

通过快照深拷贝实现状态回滚。

### [`src/commands/Clipboard.js`](src/commands/Clipboard.js)

复制粘贴系统：

- `copy`
- `paste`
- `copyAndPaste`
- `hasClipboardContent`
- `clearClipboard`

会重建 id 映射，保证粘贴后节点/边不冲突。

### [`src/commands/AutoRecord.js`](src/commands/AutoRecord.js)

自动历史记录：

- 监听鼠标抬起
- 对比当前状态与历史快照
- 有变化才记录，避免历史爆炸

---

## 4.6 components（界面层）

### [`src/components/Header.jsx`](src/components/Header.jsx)

顶部栏：

- Logo
- 蓝图名输入框
- 运行/导入/导出按钮
- 与 `ws`、导入导出命令联动

### [`src/components/Sidebar.jsx`](src/components/Sidebar.jsx)

侧边栏：

- 分类栏
- 节点列表
- 拖拽节点到画布

并且初始化请求注册表数据。

### [`src/components/Blueprint.jsx`](src/components/Blueprint.jsx)

画布主组件（ReactFlow 容器）：

- 渲染节点和连线
- 处理节点变化、连线变化
- 处理拖放创建节点
- 空白点击清空选择
- 组合 `ToolBar / NodeMenu / NodePanel`

### [`src/components/Node.jsx`](src/components/Node.jsx)

单个节点渲染 + 交互核心：

- 输入端口组、节点名、输出端口组
- 单击/右键/双击
- 输入端口断线重连（有拖拽阈值检测）
- 兼容端口新旧格式

### [`src/components/ToolBar.jsx`](src/components/ToolBar.jsx)

工具栏：

- 撤销/重做
- 缩放控制
- 一键整理

按钮都通过 `window.cmd` 触发命令。

### [`src/components/NodeMenu.jsx`](src/components/NodeMenu.jsx)

节点右键菜单：

- 复制粘贴
- 重命名
- 删除节点

菜单位置会跟着目标节点走。

### [`src/components/NodePanel.jsx`](src/components/NodePanel.jsx)

节点属性面板（大模块）：

- 根据参数类型渲染不同编辑器
- 支持 `int / float / bool / list / enum / str`
- 在节点下方定位显示
- 更新参数后回写 store

这是参数系统的前端核心。

### [`src/components/RenameModal.jsx`](src/components/RenameModal.jsx)

重命名弹窗：

- 接收节点 id 列表
- 支持 Enter 确认 / Esc 取消
- 批量调用 `renameNode`

---

## 4.7 utils（纯工具层）

### [`src/utils/generateId.js`](src/utils/generateId.js)

ID 生成工具：

- `generateId`
- `generateNodeId`
- `generateEdgeId`

使用时间戳 + 随机数，冲突概率低。

### [`src/utils/position.js`](src/utils/position.js)

坐标转换：

- 屏幕坐标 <-> 画布坐标
- 支持事件对象/对象参数/数字参数多形态

### [`src/utils/layout.js`](src/utils/layout.js)

自动布局算法实现（超大文件，核心算法区）：

- 图预处理
- 环检测与处理
- 分层
- 虚拟节点插入
- 交叉优化
- 位置计算

如果要优化“一键整理”，重点啃这个文件。

---

## 4.8 styles（样式层）

### [`src/styles/Global.css`](src/styles/Global.css)

全局基础样式、主题变量、布局骨架、滚动条。

### [`src/styles/Header.css`](src/styles/Header.css)

顶部栏样式（Logo、输入框、按钮组）。

### [`src/styles/SideBar.css`](src/styles/SideBar.css)

侧边栏样式（分类区、节点列表、节点卡片）。

### [`src/styles/Blueprint.css`](src/styles/Blueprint.css)

画布样式，含 ReactFlow 框选矩形处理（避免影响右键）。

### [`src/styles/Node.css`](src/styles/Node.css)

节点本体与端口样式，含“选中发光态”。

### [`src/styles/ToolBar.css`](src/styles/ToolBar.css)

工具栏样式。

### [`src/styles/NodeMenu.css`](src/styles/NodeMenu.css)

节点菜单样式。

### [`src/styles/NodePanel.css`](src/styles/NodePanel.css)

参数面板样式（含 Select/ListBox 细节覆盖）。

### [`src/styles/RenameModal.css`](src/styles/RenameModal.css)

重命名弹窗样式。

---

## 4.9 assets（图标资源）

### [`src/assets/logo.svg`](src/assets/logo.svg)
### [`src/assets/comment.svg`](src/assets/comment.svg)
### [`src/assets/delete-closed.svg`](src/assets/delete-closed.svg)
### [`src/assets/delete-open.svg`](src/assets/delete-open.svg)
### [`src/assets/user-avatar.svg`](src/assets/user-avatar.svg)
### [`src/assets/warning.svg`](src/assets/warning.svg)

通用图标资源。

### [`src/assets/category/basic.svg`](src/assets/category/basic.svg)
### [`src/assets/category/default.svg`](src/assets/category/default.svg)
### [`src/assets/category/function.svg`](src/assets/category/function.svg)
### [`src/assets/category/math.svg`](src/assets/category/math.svg)
### [`src/assets/category/neural.svg`](src/assets/category/neural.svg)

分类图标。

### [`src/assets/ContextMenu/copy-paste.svg`](src/assets/ContextMenu/copy-paste.svg)
### [`src/assets/ContextMenu/delete-node.svg`](src/assets/ContextMenu/delete-node.svg)
### [`src/assets/ContextMenu/rename.svg`](src/assets/ContextMenu/rename.svg)

右键菜单图标。

### [`src/assets/ToolBar/arrange.svg`](src/assets/ToolBar/arrange.svg)
### [`src/assets/ToolBar/redo.svg`](src/assets/ToolBar/redo.svg)
### [`src/assets/ToolBar/search.svg`](src/assets/ToolBar/search.svg)
### [`src/assets/ToolBar/undo.svg`](src/assets/ToolBar/undo.svg)
### [`src/assets/ToolBar/zoom-in.svg`](src/assets/ToolBar/zoom-in.svg)
### [`src/assets/ToolBar/zoom-out.svg`](src/assets/ToolBar/zoom-out.svg)

工具栏图标。

---

## 5. 你要改功能时，建议走这条“安全路线”

1. 先确认改动属于哪一层：UI、命令、状态、算法、通信。  
2. 优先改 `commands`，组件只负责触发。  
3. 改状态字段时，一次性搜全项目引用。  
4. 涉及节点参数，确认 `registry -> createNode -> NodePanel` 全链路一致。  
5. 涉及连接逻辑，确认 `Node.jsx` 端口交互与 `Edge.js` 删除/创建规则一致。  
6. 跑通基本回归：创建、连线、重命名、删除、撤销、重做、导入导出。

---

## 6. 常见坑位（新人高频踩雷）

### 坑 1：组件里直接写复杂状态逻辑

后果：逻辑分散，后续难排查。  
建议：把逻辑搬进 `commands`。

### 坑 2：节点参数结构理解错

当前参数经常是对象形态（含 `type/value/range/options`），不是单值。  
建议：先看注册表示例再改 NodePanel。

### 坑 3：只改了某个命令，忘了全局挂载

新命令不在 `window.cmd` 暴露，组件调用不到。  
建议：改完检查 `commands/index.js`。

### 坑 4：只改视觉，不管交互坐标

NodeMenu、NodePanel 位置依赖 ReactFlow 坐标转换。  
建议：改定位逻辑前先看 `flowToScreenPosition` 的调用。

### 坑 5：历史记录“看起来没问题，实际撤销错乱”

如果你跳过了 record 或快照时机不对，撤销重做会诡异。  
建议：改行为逻辑后重点回归 History。

---

## 7. 推荐阅读顺序（30 分钟速通版）

1. [`项目架构.txt`](项目架构.txt)（先知道目标）  
2. [`src/store.js`](src/store.js)（先知道数据长啥样）  
3. [`src/commands/index.js`](src/commands/index.js)（先知道能力清单）  
4. [`src/commands/Node.js`](src/commands/Node.js) + [`src/commands/Edge.js`](src/commands/Edge.js)  
5. [`src/components/Blueprint.jsx`](src/components/Blueprint.jsx) + [`src/components/Node.jsx`](src/components/Node.jsx)  
6. [`src/components/NodePanel.jsx`](src/components/NodePanel.jsx)（参数系统）  
7. [`src/ws.js`](src/ws.js)（后端联动）

---

## 8. 给贡献者的落地建议（非常实用）

- 先从“小改动、高价值”切入：文档补充、边界修复、空值保护。  
- 新功能尽量拆成多个小 PR，不要一口气改半个仓库。  
- 写清楚“为什么这样改”，比“改了什么”更重要。  
- 如果你发现注释与代码不一致，优先修注释或顺带对齐实现。  

---

## 9. 一句话总结

这个项目的核心不是“炫技”，而是“可理解、可协作、可扩展”。你只要坚持：

- 组件薄一点  
- 命令稳一点  
- 注释白话一点  
- 参数兼容多一点

你就能很快融入并做出高质量贡献。
